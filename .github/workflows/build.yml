name: Build Documentation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Add any Python dependencies if needed in future
        
    - name: Verify documentation structure
      run: |
        echo "Checking documentation files..."
        ls -la docs/
        
    - name: Build consolidated documentation
      run: |
        make clean
        make md
        
    - name: Verify build output
      run: |
        if [ ! -f mcp-architecture.md ]; then
          echo "Error: mcp-architecture.md was not generated"
          exit 1
        fi
        echo "Build successful!"
        wc -l mcp-architecture.md
        
    - name: Check for TODO/FIXME markers
      run: |
        echo "Checking for TODO/FIXME markers in documentation..."
        if grep -r "TODO\|FIXME\|XXX" docs/*.md; then
          echo "Warning: Found TODO/FIXME markers in documentation"
          echo "Please address these before merging"
          exit 1
        fi
        echo "No TODO/FIXME markers found"
      continue-on-error: true
      
    - name: Upload consolidated documentation
      uses: actions/upload-artifact@v4
      with:
        name: mcp-architecture
        path: mcp-architecture.md
        retention-days: 30

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install markdownlint-cli
      run: |
        npm install -g markdownlint-cli
        
    - name: Run markdown lint
      run: |
        markdownlint 'docs/**/*.md' --config .markdownlint.json || true
      continue-on-error: true
      
    - name: Check markdown syntax
      run: |
        echo "Validating markdown syntax..."
        for file in docs/*.md; do
          echo "Checking $file"
          # Basic syntax validation
          if ! grep -q "^#" "$file"; then
            echo "Warning: $file has no headings"
          fi
        done

  validate-links:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Check internal links
      run: |
        echo "Validating internal documentation links..."
        for file in docs/*.md README.md; do
          echo "Checking links in $file"
          # Extract markdown links and verify targets exist
          grep -oP '\[.*?\]\(\K[^)]+' "$file" | while read link; do
            if [[ "$link" =~ ^docs/ ]]; then
              if [ ! -f "$link" ]; then
                echo "Error: Broken link in $file -> $link"
                exit 1
              fi
            fi
          done
        done
        echo "All internal links valid"
      continue-on-error: true

  summary:
    runs-on: ubuntu-latest
    needs: [build, lint, validate-links]
    if: always()
    
    steps:
    - name: Job Summary
      run: |
        echo "## Documentation Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Lint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Link Validation: ${{ needs.validate-links.result }}" >> $GITHUB_STEP_SUMMARY
